<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>語音識別</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/opencc-js@1.0.5/dist/umd/full.min.js"></script>
</head>
<body>
<div class="container mt-5">
    <h1 class="text-center">語音識別測試</h1>
    <div class="text-center mt-4">
        <button id="recordButton" class="btn btn-primary">開始錄音</button>
        <button id="stopButton" class="btn btn-danger" disabled>停止錄音</button>
    </div>
    <div class="mt-3">
        <h4>識別結果：</h4>
        <div id="result" class="alert alert-secondary" style="white-space: pre-wrap;"></div>
    </div>
</div>

<script>
    // 宣告變數來儲存 MediaRecorder 物件和錄音片段資料
    let mediaRecorder;
    let audioChunks = [];

    // 當按下「開始錄音」按鈕時，執行以下代碼
    document.getElementById("recordButton").addEventListener("click", () => {
        // 使用 getUserMedia 來訪問使用者的麥克風
        navigator.mediaDevices.getUserMedia({audio: true})
            .then(stream => {
                // 創建 MediaRecorder 物件來錄製音頻
                mediaRecorder = new MediaRecorder(stream);
                audioChunks = [];

                // 開始錄音
                mediaRecorder.start();

                // 當有音頻資料可用時，將其儲存到 audioChunks 中
                mediaRecorder.addEventListener("dataavailable", event => {
                    audioChunks.push(event.data);
                });

                // 當錄音停止時，將音頻片段組合成一個 Blob 並上傳到伺服器
                mediaRecorder.addEventListener("stop", () => {
                    const audioBlob = new Blob(audioChunks, {type: 'audio/wav'});
                    const formData = new FormData();
                    formData.append('file', audioBlob);

                    // 將音頻文件發送到後端進行處理
                    fetch("/upload", {
                        method: "POST",
                        body: formData
                    })
                        .then(response => response.text())
                        .then(data => {
                            // 使用 OpenCC 將簡體中文轉換為繁體中文
                            const converter = OpenCC.Converter({ from: 'cn', to: 'tw' });
                            const traditionalText = converter(data);
                            // 將轉換後的結果顯示在網頁上
                            document.getElementById("result").innerText = "識別結果：" + traditionalText;
                        })
                        .catch(err => {
                            // 如果上傳失敗，顯示錯誤訊息
                            console.error("語音上傳失敗：", err);
                            document.getElementById("result").innerText = "識別失敗，請重試！";
                        });
                });

                // 禁用「開始錄音」按鈕，啟用「停止錄音」按鈕
                document.getElementById("recordButton").disabled = true;
                document.getElementById("stopButton").disabled = false;
            })
            .catch(err => {
                // 如果無法訪問麥克風，顯示錯誤訊息
                alert("無法訪問麥克風，請檢查權限！");
                console.error("錄音失敗：", err);
            });
    });

    // 當按下「停止錄音」按鈕時，停止錄音並啟用「開始錄音」按鈕
    document.getElementById("stopButton").addEventListener("click", () => {
        mediaRecorder.stop();
        document.getElementById("recordButton").disabled = false;
        document.getElementById("stopButton").disabled = true;
    });
</script>
</body>
</html>
