<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>語音識別</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
<div class="container mt-5">
    <h1 class="text-center">語音識別測試</h1>
    <div class="text-center mt-4">
        <button id="recordButton" class="btn btn-primary">開始錄音</button>
        <button id="stopButton" class="btn btn-danger" disabled>停止錄音</button>
    </div>
    <div class="mt-3">
        <h4>識別結果：</h4>
        <div id="result" class="alert alert-secondary" style="white-space: pre-wrap;"></div>
    </div>
</div>

<script>
    let mediaRecorder;
    let audioChunks = [];

    document.getElementById("recordButton").addEventListener("click", () => {
        navigator.mediaDevices.getUserMedia({audio: true})
            .then(stream => {
                mediaRecorder = new MediaRecorder(stream);
                audioChunks = [];

                mediaRecorder.start();

                mediaRecorder.addEventListener("dataavailable", event => {
                    audioChunks.push(event.data);
                });

                mediaRecorder.addEventListener("stop", () => {
                    const audioBlob = new Blob(audioChunks, {type: 'audio/wav'});
                    const formData = new FormData();
                    formData.append('file', audioBlob);

                    fetch("/upload", {
                        method: "POST",
                        body: formData
                    })
                        .then(response => response.text())
                        .then(data => {
                            document.getElementById("result").innerText = "識別結果：" + data;
                        })
                        .catch(err => {
                            console.error("語音上傳失敗：", err);
                            document.getElementById("result").innerText = "識別失敗，請重試！";
                        });
                });

                document.getElementById("recordButton").disabled = true;
                document.getElementById("stopButton").disabled = false;
            })
            .catch(err => {
                alert("無法訪問麥克風，請檢查權限！");
                console.error("錄音失敗：", err);
            });
    });

    document.getElementById("stopButton").addEventListener("click", () => {
        mediaRecorder.stop();
        document.getElementById("recordButton").disabled = false;
        document.getElementById("stopButton").disabled = true;
    });
</script>
</body>
</html>
